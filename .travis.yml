language: go

services:
  - docker

dist: trusty

go:
  - "tip"

env:
  global:
    - IMAGINARY_VERSION="${TRAVIS_TAG:-dev}"
  matrix:
    - LIBVIPS=8.7.2 GO_VERSION=latest
    - LIBVIPS=8.7.3 GO_VERSION=latest
    - LIBVIPS=8.7.4 GO_VERSION=latest
    - LIBVIPS=8.7.4 GO_VERSION=rc
    - LIBVIPS=8.7.4 GO_VERSION=1.10

matrix:
  allow_failures:
    - env: LIBVIPS=8.7.2
    - env: GO_VERSION=rc

before_install:
  - docker pull h2non/imaginary:latest || true

install:
  - true # Overriding default behaviour

script:
  - docker build --pull --cache-from h2non/imaginary:latest --build-arg GO_VERSION="${GO_VERSION}" --build-arg LIBVIPS_VERSION="${LIBVIPS}" --build-arg IMAGINARY_VERSION="${IMAGINARY_VERSION#v}" --tag h2non/imaginary:${IMAGINARY_VERSION} .
  - docker run --rm -it h2non/imaginary:${IMAGINARY_VERSION} -v || true # Verifying new version numbers

before_deploy:
#  - docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS"

deploy:
#  provider: script
#  script:
#    - docker tag h2non/imaginary:${IMAGINARY_VERSION} latest
#    - docker push h2non/imaginary:${IMAGINARY_VERSION}
#    - docker push h2non/imaginary:latest
#  on:
#    condition: "${TRAVIS_TAG} =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$"
